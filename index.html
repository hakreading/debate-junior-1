<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Listen and Arrange</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        h1, h2, .font-fredoka {
            font-family: 'Fredoka', sans-serif;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-10vh) rotateZ(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotateZ(720deg); opacity: 0; }
        }
        .confetti {
            position: absolute;
            top: 0;
            border-radius: 2px;
            animation-name: confetti-fall;
            animation-timing-function: linear;
            animation-fill-mode: forwards;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
  }
}
</script>
</head>
<body class="bg-gradient-to-br from-[#aed6f1] to-[#d5f5e3]">
    <div id="root"></div>
    <script type="module">
        import React, { useState, useEffect, useCallback, useRef } from 'react';
        import ReactDOM from 'react-dom/client';

        // --- from types.ts ---
        const GameState = {
          Initial: 'Initial',
          UnitSelection: 'UnitSelection',
          Playing: 'Playing',
          Finished: 'Finished',
        };

        // --- from constants.ts ---
        const QA_PAIRS = [
          {
            question_en: "Unit 1: Books vs. Smartphones",
            question_vi: "BÃ i 1: SÃ¡ch vÃ  Äiá»‡n thoáº¡i thÃ´ng minh",
            answers: [
              // Warm-up
              { en: "What is your favorite book?", vi: "Cuá»‘n sÃ¡ch yÃªu thÃ­ch cá»§a báº¡n lÃ  gÃ¬?" },
              { en: "What do you do on your smartphone?", vi: "Báº¡n lÃ m gÃ¬ trÃªn Ä‘iá»‡n thoáº¡i thÃ´ng minh cá»§a mÃ¬nh?" },
              { en: "Which is more fun for you, reading books or using smartphones?", vi: "Äá»‘i vá»›i báº¡n, Ä‘á»c sÃ¡ch hay sá»­ dá»¥ng Ä‘iá»‡n thoáº¡i thÃ´ng minh vui hÆ¡n?" },
              // Introducing the Topic
              { en: "Only half of children between 6 and 11 years old like to read for fun these days.", vi: "NgÃ y nay, chá»‰ má»™t ná»­a sá»‘ tráº» em tá»« 6 Ä‘áº¿n 11 tuá»•i thÃ­ch Ä‘á»c sÃ¡ch Ä‘á»ƒ giáº£i trÃ­." },
              { en: "More than 10 percent of children do not like to read books at all.", vi: "HÆ¡n 10 pháº§n trÄƒm tráº» em hoÃ n toÃ n khÃ´ng thÃ­ch Ä‘á»c sÃ¡ch." },
              { en: "One reason for this is that more children use smartphones.", vi: "Má»™t lÃ½ do cho Ä‘iá»u nÃ y lÃ  ngÃ y cÃ ng nhiá»u tráº» em sá»­ dá»¥ng Ä‘iá»‡n thoáº¡i thÃ´ng minh." },
              { en: "Almost 100 percent of children use smartphones during the day.", vi: "Gáº§n 100 pháº§n trÄƒm tráº» em sá»­ dá»¥ng Ä‘iá»‡n thoáº¡i thÃ´ng minh trong ngÃ y." },
              // Learning about the Topic
              { en: "Should children read books instead of using smartphones?", vi: "Tráº» em cÃ³ nÃªn Ä‘á»c sÃ¡ch thay vÃ¬ sá»­ dá»¥ng Ä‘iá»‡n thoáº¡i thÃ´ng minh khÃ´ng?" },
              { en: "In the past, children often read books.", vi: "TrÆ°á»›c Ä‘Ã¢y, tráº» em thÆ°á»ng Ä‘á»c sÃ¡ch." },
              { en: "These days, children do not read many books.", vi: "NgÃ y nay, tráº» em khÃ´ng Ä‘á»c nhiá»u sÃ¡ch." },
              { en: "Many children prefer to use smartphones.", vi: "Nhiá»u tráº» em thÃ­ch sá»­ dá»¥ng Ä‘iá»‡n thoáº¡i thÃ´ng minh hÆ¡n." },
              { en: "Are smartphones good for children?", vi: "Äiá»‡n thoáº¡i thÃ´ng minh cÃ³ tá»‘t cho tráº» em khÃ´ng?" },
              { en: "First of all, children can learn specific information.", vi: "TrÆ°á»›c háº¿t, tráº» em cÃ³ thá»ƒ há»c Ä‘Æ°á»£c thÃ´ng tin cá»¥ thá»ƒ." },
              { en: "Books can have lots of detailed text.", vi: "SÃ¡ch cÃ³ thá»ƒ cÃ³ ráº¥t nhiá»u vÄƒn báº£n chi tiáº¿t." },
              { en: "So children can learn a lot from books.", vi: "VÃ¬ váº­y, tráº» em cÃ³ thá»ƒ há»c Ä‘Æ°á»£c ráº¥t nhiá»u tá»« sÃ¡ch." },
              { en: "Children can learn everything about that person.", vi: "Tráº» em cÃ³ thá»ƒ há»c má»i thá»© vá» ngÆ°á»i Ä‘Ã³." },
              { en: "However, this is hard to do with smartphones.", vi: "Tuy nhiÃªn, Ä‘iá»u nÃ y khÃ³ thá»±c hiá»‡n vá»›i Ä‘iá»‡n thoáº¡i thÃ´ng minh." },
              { en: "Next, books allow children to improve their verbal skills.", vi: "Tiáº¿p theo, sÃ¡ch cho phÃ©p tráº» em cáº£i thiá»‡n ká»¹ nÄƒng nÃ³i cá»§a mÃ¬nh." },
              { en: "Reading helps children learn new words.", vi: "Äá»c sÃ¡ch giÃºp tráº» há»c tá»« má»›i." },
              { en: "When they speak, they can use new words.", vi: "Khi nÃ³i, cÃ¡c em cÃ³ thá»ƒ sá»­ dá»¥ng tá»« má»›i." },
              { en: "When they hear a difficult word, they can understand its meaning.", vi: "Khi nghe má»™t tá»« khÃ³, cÃ¡c em cÃ³ thá»ƒ hiá»ƒu Ä‘Æ°á»£c nghÄ©a cá»§a nÃ³." },
              { en: "But children do not learn as many words by using smartphones.", vi: "NhÆ°ng tráº» em khÃ´ng há»c Ä‘Æ°á»£c nhiá»u tá»« báº±ng cÃ¡ch sá»­ dá»¥ng Ä‘iá»‡n thoáº¡i thÃ´ng minh." },
              { en: "For one, using smartphones is more enjoyable.", vi: "Thá»© nháº¥t, sá»­ dá»¥ng Ä‘iá»‡n thoáº¡i thÃ´ng minh thÃº vá»‹ hÆ¡n." },
              { en: "Smartphones have many different applications.", vi: "Äiá»‡n thoáº¡i thÃ´ng minh cÃ³ nhiá»u á»©ng dá»¥ng khÃ¡c nhau." },
              { en: "Children can use phones to play games, to watch videos, and to surf the Internet.", vi: "Tráº» em cÃ³ thá»ƒ dÃ¹ng Ä‘iá»‡n thoáº¡i Ä‘á»ƒ chÆ¡i game, xem video vÃ  lÆ°á»›t Internet." },
              { en: "However, books are just words printed on a page.", vi: "Tuy nhiÃªn, sÃ¡ch chá»‰ lÃ  nhá»¯ng tá»« Ä‘Æ°á»£c in trÃªn má»™t trang giáº¥y." },
              { en: "Smartphones also make learning simple.", vi: "Äiá»‡n thoáº¡i thÃ´ng minh cÅ©ng lÃ m cho viá»‡c há»c trá»Ÿ nÃªn Ä‘Æ¡n giáº£n." },
              { en: "With smartphones, learning is easier and more fun.", vi: "Vá»›i Ä‘iá»‡n thoáº¡i thÃ´ng minh, viá»‡c há»c dá»… dÃ ng vÃ  thÃº vá»‹ hÆ¡n." },
              { en: "They can see videos of famous events in history.", vi: "CÃ¡c em cÃ³ thá»ƒ xem video vá» cÃ¡c sá»± kiá»‡n lá»‹ch sá»­ ná»•i tiáº¿ng." },
              { en: "These videos can explain difficult concepts easily.", vi: "Nhá»¯ng video nÃ y cÃ³ thá»ƒ giáº£i thÃ­ch cÃ¡c khÃ¡i niá»‡m khÃ³ má»™t cÃ¡ch dá»… dÃ ng." },
              // Opinion Examples
              { en: "Here's why I think reading books is better.", vi: "ÄÃ¢y lÃ  lÃ½ do táº¡i sao tÃ´i nghÄ© Ä‘á»c sÃ¡ch tá»‘t hÆ¡n." },
              { en: "I am positive that reading books is better than using smartphones.", vi: "TÃ´i cháº¯c cháº¯n ráº±ng Ä‘á»c sÃ¡ch tá»‘t hÆ¡n lÃ  sá»­ dá»¥ng Ä‘iá»‡n thoáº¡i thÃ´ng minh." },
              { en: "When we read books, we can use our imaginations.", vi: "Khi Ä‘á»c sÃ¡ch, chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng trÃ­ tÆ°á»Ÿng tÆ°á»£ng cá»§a mÃ¬nh." },
              { en: "We can create our own ideas about the world in our minds.", vi: "ChÃºng ta cÃ³ thá»ƒ táº¡o ra nhá»¯ng Ã½ tÆ°á»Ÿng cá»§a riÃªng mÃ¬nh vá» tháº¿ giá»›i trong tÃ¢m trÃ­." },
              { en: "This helps make us smarter.", vi: "Äiá»u nÃ y giÃºp chÃºng ta thÃ´ng minh hÆ¡n." },
              { en: "But when we use smartphones, this does not happen.", vi: "NhÆ°ng khi chÃºng ta sá»­ dá»¥ng Ä‘iá»‡n thoáº¡i thÃ´ng minh, Ä‘iá»u nÃ y khÃ´ng xáº£y ra." },
              { en: "We just look at the pictures on the screen without thinking.", vi: "ChÃºng ta chá»‰ nhÃ¬n vÃ o nhá»¯ng bá»©c áº£nh trÃªn mÃ n hÃ¬nh mÃ  khÃ´ng cáº§n suy nghÄ©." },
              { en: "I don't agree!", vi: "TÃ´i khÃ´ng Ä‘á»“ng Ã½!" },
              { en: "Using smartphones is the way to go!", vi: "Sá»­ dá»¥ng Ä‘iá»‡n thoáº¡i thÃ´ng minh lÃ  lá»±a chá»n Ä‘Ãºng Ä‘áº¯n!" },
              { en: "Reading books can be hard since we have to pay attention to the words.", vi: "Äá»c sÃ¡ch cÃ³ thá»ƒ khÃ³ vÃ¬ chÃºng ta pháº£i chÃº Ã½ Ä‘áº¿n cÃ¡c tá»« ngá»¯." },
              { en: "If we don't, then we can't understand the story.", vi: "Náº¿u khÃ´ng, chÃºng ta sáº½ khÃ´ng thá»ƒ hiá»ƒu Ä‘Æ°á»£c cÃ¢u chuyá»‡n." },
              { en: "Using smartphones is easier.", vi: "Sá»­ dá»¥ng Ä‘iá»‡n thoáº¡i thÃ´ng minh dá»… dÃ ng hÆ¡n." },
              { en: "We can just relax and watch a video on the Internet or have fun playing our favorite games.", vi: "ChÃºng ta cÃ³ thá»ƒ thÆ° giÃ£n vÃ  xem video trÃªn Internet hoáº·c vui váº» chÆ¡i cÃ¡c trÃ² chÆ¡i yÃªu thÃ­ch." }
            ]
          },
          {
            question_en: "Unit 2: School Uniforms",
            question_vi: "BÃ i 2: Äá»“ng phá»¥c há»c sinh",
            answers: [
              // Warm-Up
              { en: "What kinds of clothes do you like to wear?", vi: "Báº¡n thÃ­ch máº·c loáº¡i quáº§n Ã¡o nÃ o?" },
              { en: "Do you have to wear a uniform at school?", vi: "Báº¡n cÃ³ pháº£i máº·c Ä‘á»“ng phá»¥c á»Ÿ trÆ°á»ng khÃ´ng?" },
              { en: "How long does it take you to get dressed in the mornings?", vi: "Báº¡n máº¥t bao lÃ¢u Ä‘á»ƒ máº·c quáº§n Ã¡o vÃ o buá»•i sÃ¡ng?" },
              
              // Introducing the Topic
              { en: "England was the first country to use school uniforms.", vi: "Anh lÃ  quá»‘c gia Ä‘áº§u tiÃªn sá»­ dá»¥ng Ä‘á»“ng phá»¥c há»c sinh." },
              { en: "Students there first wore school uniforms in 1552.", vi: "Há»c sinh á»Ÿ Ä‘Ã³ láº§n Ä‘áº§u tiÃªn máº·c Ä‘á»“ng phá»¥c há»c sinh vÃ o nÄƒm 1552." },
              { en: "Today, many schools require uniforms.", vi: "NgÃ y nay, nhiá»u trÆ°á»ng há»c yÃªu cáº§u Ä‘á»“ng phá»¥c." },
              { en: "Uniforms are popular in Great Britain, Australia, India, and many parts of Asia.", vi: "Äá»“ng phá»¥c phá»• biáº¿n á»Ÿ Anh, Ãšc, áº¤n Äá»™ vÃ  nhiá»u nÆ¡i á»Ÿ chÃ¢u Ã." },
              { en: "But in the United States and other places, students do not usually wear uniforms.", vi: "NhÆ°ng á»Ÿ Hoa Ká»³ vÃ  nhá»¯ng nÆ¡i khÃ¡c, há»c sinh thÆ°á»ng khÃ´ng máº·c Ä‘á»“ng phá»¥c." },
              { en: "Millions of students wear school uniforms.", vi: "HÃ ng triá»‡u há»c sinh máº·c Ä‘á»“ng phá»¥c Ä‘i há»c." },
              { en: "Teachers believe that students in uniforms behave better.", vi: "GiÃ¡o viÃªn tin ráº±ng há»c sinh máº·c Ä‘á»“ng phá»¥c cÆ° xá»­ tá»‘t hÆ¡n." },
              { en: "Some say that students should choose what they want to wear.", vi: "Má»™t sá»‘ ngÆ°á»i nÃ³i ráº±ng há»c sinh nÃªn Ä‘Æ°á»£c chá»n nhá»¯ng gÃ¬ há» muá»‘n máº·c." },
              { en: "What do you think?", vi: "Báº¡n nghÄ© sao?" },

              // School Uniforms Are Good
              { en: "First, students can dress faster.", vi: "Äáº§u tiÃªn, há»c sinh cÃ³ thá»ƒ máº·c quáº§n Ã¡o nhanh hÆ¡n." },
              { en: "Some students take 30 minutes or longer to get ready in the morning.", vi: "Má»™t sá»‘ há»c sinh máº¥t 30 phÃºt hoáº·c lÃ¢u hÆ¡n Ä‘á»ƒ chuáº©n bá»‹ sáºµn sÃ ng vÃ o buá»•i sÃ¡ng." },
              { en: "They must choose their clothes.", vi: "Há» pháº£i chá»n quáº§n Ã¡o cá»§a mÃ¬nh." },
              { en: "They have to choose the pants and shirts they want to wear.", vi: "Há» pháº£i chá»n quáº§n vÃ  Ã¡o sÆ¡ mi há» muá»‘n máº·c." },
              { en: "With uniforms, students can get dressed more quickly.", vi: "Vá»›i Ä‘á»“ng phá»¥c, há»c sinh cÃ³ thá»ƒ máº·c quáº§n Ã¡o nhanh hÆ¡n." },
              { en: "They do not choose their clothes.", vi: "Há» khÃ´ng chá»n quáº§n Ã¡o cá»§a mÃ¬nh." },
              { en: "They just put on their uniforms and go to school.", vi: "Há» chá»‰ cáº§n máº·c Ä‘á»“ng phá»¥c vÃ  Ä‘áº¿n trÆ°á»ng." },
              { en: "Second, students behave better.", vi: "Thá»© hai, há»c sinh cÆ° xá»­ tá»‘t hÆ¡n." },
              { en: "This was proven by a study.", vi: "Äiá»u nÃ y Ä‘Ã£ Ä‘Æ°á»£c chá»©ng minh bá»Ÿi má»™t nghiÃªn cá»©u." },
              { en: "It says that students who wear uniforms have better attendance.", vi: "NÃ³ nÃ³i ráº±ng nhá»¯ng há»c sinh máº·c Ä‘á»“ng phá»¥c cÃ³ tá»· lá»‡ chuyÃªn cáº§n tá»‘t hÆ¡n." },
              { en: "They study harder.", vi: "Há» há»c chÄƒm chá»‰ hÆ¡n." },
              { en: "They also have higher high school graduation rates.", vi: "Há» cÅ©ng cÃ³ tá»· lá»‡ tá»‘t nghiá»‡p trung há»c phá»• thÃ´ng cao hÆ¡n." },

              // School Uniforms Are Not Good
              { en: "For one, paying for uniforms is unfair.", vi: "Thá»© nháº¥t, viá»‡c tráº£ tiá»n cho Ä‘á»“ng phá»¥c lÃ  khÃ´ng cÃ´ng báº±ng." },
              { en: "Public schools are free.", vi: "CÃ¡c trÆ°á»ng cÃ´ng láº­p Ä‘á»u miá»…n phÃ­." },
              { en: "Students there do not pay for education.", vi: "Há»c sinh á»Ÿ Ä‘Ã³ khÃ´ng pháº£i tráº£ tiá»n cho giÃ¡o dá»¥c." },
              { en: "Therefore, they should not buy uniforms.", vi: "VÃ¬ váº­y, há» khÃ´ng nÃªn mua Ä‘á»“ng phá»¥c." },
              { en: "They are also too expensive.", vi: "ChÃºng cÅ©ng quÃ¡ Ä‘áº¯t." },
              { en: "One uniform costs a couple of hundred dollars.", vi: "Má»™t bá»™ Ä‘á»“ng phá»¥c cÃ³ giÃ¡ vÃ i trÄƒm Ä‘Ã´ la." },
              { en: "Some families cannot pay this much money for clothes.", vi: "Má»™t sá»‘ gia Ä‘Ã¬nh khÃ´ng thá»ƒ tráº£ nhiá»u tiá»n nhÆ° váº­y cho quáº§n Ã¡o." },
              { en: "Additionally, students should have the freedom to choose what they want to wear.", vi: "NgoÃ i ra, há»c sinh nÃªn cÃ³ quyá»n tá»± do lá»±a chá»n nhá»¯ng gÃ¬ há» muá»‘n máº·c." },
              { en: "Uniforms are a type of censorship because students cannot wear the clothes they want.", vi: "Äá»“ng phá»¥c lÃ  má»™t hÃ¬nh thá»©c kiá»ƒm duyá»‡t vÃ¬ há»c sinh khÃ´ng thá»ƒ máº·c quáº§n Ã¡o há» muá»‘n." },
              { en: "Students should be allowed to express themselves with their clothing.", vi: "Há»c sinh nÃªn Ä‘Æ°á»£c phÃ©p thá»ƒ hiá»‡n báº£n thÃ¢n qua trang phá»¥c cá»§a mÃ¬nh." },
              { en: "This will help them show their identity.", vi: "Äiá»u nÃ y sáº½ giÃºp há» thá»ƒ hiá»‡n báº£n sáº¯c cá»§a mÃ¬nh." },
              
              // Opinions (Joshua)
              { en: "Wearing uniforms is clearly better!", vi: "Máº·c Ä‘á»“ng phá»¥c rÃµ rÃ ng lÃ  tá»‘t hÆ¡n!" },
              { en: "Wearing uniforms is good for students.", vi: "Máº·c Ä‘á»“ng phá»¥c ráº¥t tá»‘t cho há»c sinh." },
              { en: "With uniforms, students don't have to worry about clothing.", vi: "Vá»›i Ä‘á»“ng phá»¥c, há»c sinh khÃ´ng pháº£i lo láº¯ng vá» quáº§n Ã¡o." },
              { en: "They can go to school and focus on their studies.", vi: "Há» cÃ³ thá»ƒ Ä‘áº¿n trÆ°á»ng vÃ  táº­p trung vÃ o viá»‡c há»c." },
              { en: "This will help them work harder in class.", vi: "Äiá»u nÃ y sáº½ giÃºp há» há»c táº­p chÄƒm chá»‰ hÆ¡n trong lá»›p." },
              { en: "Without uniforms, students will spend more time and money on clothes.", vi: "Náº¿u khÃ´ng cÃ³ Ä‘á»“ng phá»¥c, há»c sinh sáº½ tá»‘n nhiá»u thá»i gian vÃ  tiá»n báº¡c hÆ¡n cho quáº§n Ã¡o." },
              { en: "This does not help their studies.", vi: "Äiá»u nÃ y khÃ´ng giÃºp Ã­ch cho viá»‡c há»c cá»§a há»." },

              // Opinions (Melissa)
              { en: "No way! Students shouldn't wear uniforms!", vi: "KhÃ´ng Ä‘á»i nÃ o! Há»c sinh khÃ´ng nÃªn máº·c Ä‘á»“ng phá»¥c!" },
              { en: "I don't think students need to wear uniforms.", vi: "TÃ´i khÃ´ng nghÄ© há»c sinh cáº§n máº·c Ä‘á»“ng phá»¥c." },
              { en: "Uniforms are expensive.", vi: "Äá»“ng phá»¥c thÃ¬ Ä‘áº¯t tiá»n." },
              { en: "If you can wear your normal clothes to school, you don't need uniforms.", vi: "Náº¿u báº¡n cÃ³ thá»ƒ máº·c quáº§n Ã¡o bÃ¬nh thÆ°á»ng Ä‘áº¿n trÆ°á»ng, báº¡n khÃ´ng cáº§n Ä‘á»“ng phá»¥c." },
              { en: "In addition, students can study hard without uniforms.", vi: "NgoÃ i ra, há»c sinh cÃ³ thá»ƒ há»c táº­p chÄƒm chá»‰ mÃ  khÃ´ng cáº§n Ä‘á»“ng phá»¥c." },
              { en: "Students who want to get good grades will always study hard.", vi: "Nhá»¯ng há»c sinh muá»‘n Ä‘áº¡t Ä‘iá»ƒm cao sáº½ luÃ´n há»c táº­p chÄƒm chá»‰." },
              { en: "The clothes they wear will not matter.", vi: "Quáº§n Ã¡o há» máº·c sáº½ khÃ´ng thÃ nh váº¥n Ä‘á»." }
            ]
          }
        ];

        // --- from components/BubbleContainer.tsx ---
        const ConfettiContainer = ({ show, onAnimationEnd }) => {
          const [pieces, setPieces] = useState([]);

          useEffect(() => {
            if (show) {
              const newPieces = [];
              const colors = ['#f1c40f', '#e74c3c', '#3498db', '#2ecc71', '#9b59b6'];
              for (let i = 0; i < 70; i++) {
                newPieces.push({
                  id: Date.now() + i,
                  left: Math.random() * 100,
                  duration: Math.random() * 2000 + 1500, // 1.5s to 3.5s
                  delay: Math.random() * 1000,
                  width: Math.random() * 8 + 6,
                  height: Math.random() * 10 + 8,
                  background: colors[Math.floor(Math.random() * colors.length)],
                  transform: `rotate(${Math.random() * 360}deg)`,
                });
              }
              setPieces(newPieces);

              const longestAnimation = Math.max(...newPieces.map(p => p.duration + p.delay));
              const timer = setTimeout(() => {
                setPieces([]);
                onAnimationEnd();
              }, longestAnimation);
              
              return () => clearTimeout(timer);
            }
          }, [show, onAnimationEnd]);

          return (
            React.createElement('div', { className: "fixed top-0 left-0 w-full h-full pointer-events-none z-50 overflow-hidden" },
              pieces.map((piece) => (
                React.createElement('div', {
                  key: piece.id,
                  className: "confetti",
                  style: {
                    left: `${piece.left}vw`,
                    width: `${piece.width}px`,
                    height: `${piece.height}px`,
                    background: piece.background,
                    transform: piece.transform,
                    animationDuration: `${piece.duration}ms`,
                    animationDelay: `${piece.delay}ms`,
                  }
                })
              ))
            )
          );
        };
        
        // --- from components/ReviewModal.tsx ---
        const ReviewModal = ({ isOpen, onClose, mistakes }) => {
          useEffect(() => {
            const handleEsc = (event) => {
              if (event.key === 'Escape') {
                onClose();
              }
            };
            window.addEventListener('keydown', handleEsc);

            return () => {
              window.removeEventListener('keydown', handleEsc);
            };
          }, [onClose]);

          if (!isOpen) {
            return null;
          }

          return (
            React.createElement('div', { 
              className: "fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70",
              onClick: onClose
            },
              React.createElement('div', { 
                className: "bg-white text-slate-800 m-auto p-5 border-2 border-gray-200 w-11/12 max-w-2xl rounded-2xl max-h-[80vh] overflow-y-auto shadow-2xl",
                onClick: (e) => e.stopPropagation()
              },
                React.createElement('div', { className: "flex justify-between items-center mb-4" },
                  React.createElement('h2', { className: "font-fredoka text-2xl text-[#2980b9]" }, "Xem láº¡i lá»—i sai (Review Mistakes)"),
                  React.createElement('button', { onClick: onClose, className: "text-gray-400 text-3xl font-bold hover:text-gray-600" }, "Ã—")
                ),
                React.createElement('p', { className: "mb-6" }, "DÆ°á»›i Ä‘Ã¢y lÃ  cÃ¡c cÃ¢u báº¡n Ä‘Ã£ xáº¿p sai hoáº·c bá» qua. HÃ£y ghi nhá»› Ä‘á»ƒ rÃºt kinh nghiá»‡m nhÃ©!"),
                React.createElement('ul', { className: "list-none p-0" },
                  mistakes.map((item, index) => (
                    React.createElement('li', { key: index, className: "bg-blue-50 rounded-lg p-4 mb-3 text-left border-l-4 border-red-500 text-base" },
                      React.createElement('em', { className: "block mt-1.5 text-gray-600 text-sm whitespace-pre-wrap" }, `Ngá»¯ cáº£nh (Context): ${item.context_vi}`),
                      React.createElement('strong', { className: "text-green-700 font-bold block mt-2" }, `CÃ¢u Ä‘Ãºng (Correct Sentence): ${item.correct_en}`),
                      React.createElement('em', { className: "block mt-1 text-gray-600 text-sm" }, `Báº¡n Ä‘Ã£ xáº¿p: ${item.attempted}`)
                    )
                  ))
                )
              )
            )
          );
        };
        
        // --- from components/ReadAloudScreen.tsx ---
        const ReadAloudScreen = ({ items, onClose, selectedVoice }) => {
          const [currentIndex, setCurrentIndex] = useState(0);
          const [isPlaying, setIsPlayingState] = useState(true);
          const isPlayingRef = useRef(true);

          const setIsPlaying = useCallback((playing) => {
            isPlayingRef.current = playing;
            setIsPlayingState(playing);
          }, []);

          const speak = useCallback((index) => {
            if (index >= items.length) {
              setIsPlaying(false);
              return;
            }
            const item = items[index];
            const utterance = new SpeechSynthesisUtterance(item.en);
            utterance.lang = 'en-US';
            utterance.rate = 0.9;
            if (selectedVoice) {
              utterance.voice = selectedVoice;
            }
            utterance.onend = () => {
              if (isPlayingRef.current) {
                setCurrentIndex(prev => prev + 1);
              }
            };
            speechSynthesis.cancel();
            speechSynthesis.speak(utterance);
          }, [items, selectedVoice, setIsPlaying]);

          useEffect(() => {
            if (isPlaying) {
              if (speechSynthesis.paused) {
                speechSynthesis.resume();
              } else {
                speak(currentIndex);
              }
            } else {
              speechSynthesis.pause();
            }
          }, [currentIndex, isPlaying, speak]);

          useEffect(() => {
            return () => {
              speechSynthesis.cancel();
            };
          }, []);

          const handlePlayPause = () => {
            if (isPlaying) {
              setIsPlaying(false);
            } else {
              if (currentIndex >= items.length) {
                setCurrentIndex(0);
              }
              setIsPlaying(true);
            }
          };

          const handleNext = () => {
            if (currentIndex < items.length - 1) {
              setCurrentIndex(prev => prev + 1);
            }
          };

          const handlePrev = () => {
            if (currentIndex > 0) {
              setCurrentIndex(prev => prev - 1);
            }
          };

          const currentItem = items[currentIndex];
          const isFinished = currentIndex >= items.length;

          return (
            React.createElement('div', { className: "fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm" },
              React.createElement('div', { className: "bg-white text-slate-800 m-auto p-6 border-2 border-gray-200 w-11/12 max-w-2xl rounded-2xl max-h-[90vh] overflow-y-auto shadow-2xl flex flex-col" },
                React.createElement('div', { className: "flex justify-between items-center mb-4" },
                  React.createElement('h2', { className: "font-fredoka text-2xl text-[#16a085]" }, "Äá»c ToÃ n Bá»™ Unit (Read Aloud)"),
                  React.createElement('button', { onClick: onClose, className: "text-gray-400 text-3xl font-bold hover:text-gray-600" }, "Ã—")
                ),
                React.createElement('div', { className: "flex-grow my-6 text-center min-h-[120px] flex flex-col justify-center" },
                    isFinished ? (
                      React.createElement('p', { className: "text-xl sm:text-2xl font-bold text-slate-800 mb-4" }, "ÄÃ£ Ä‘á»c xong! (Finished!)")
                    ) : currentItem ? (
                      React.createElement(React.Fragment, null,
                        React.createElement('p', { className: "text-xl sm:text-2xl font-bold text-slate-800 mb-4" }, currentItem.en),
                        React.createElement('p', { className: "text-base sm:text-lg text-gray-600" }, currentItem.vi)
                      )
                    ) : null
                ),
                React.createElement('div', { className: "text-center mb-4" },
                    React.createElement('p', { className: "font-semibold" }, `${Math.min(currentIndex + 1, items.length)} / ${items.length}`)
                ),
                React.createElement('div', { className: "flex justify-center items-center gap-4" },
                    React.createElement('button', { onClick: handlePrev, disabled: currentIndex === 0, className: "py-2 px-4 text-base cursor-pointer text-white border-none rounded-lg font-bold transition-all duration-300 bg-gray-500 hover:enabled:bg-gray-600 disabled:bg-gray-300 disabled:cursor-not-allowed" }, "Â« Previous"),
                    React.createElement('button', { onClick: handlePlayPause, className: "py-3 px-8 text-lg cursor-pointer text-white border-none rounded-lg font-bold transition-all duration-300 bg-[#3498db] hover:enabled:bg-[#2980b9]" }, isPlaying ? 'âšâš Pause' : 'â–º Play'),
                    React.createElement('button', { onClick: handleNext, disabled: isFinished || currentIndex === items.length - 1, className: "py-2 px-4 text-base cursor-pointer text-white border-none rounded-lg font-bold transition-all duration-300 bg-gray-500 hover:enabled:bg-gray-600 disabled:bg-gray-300 disabled:cursor-not-allowed" }, "Next Â»")
                )
              )
            )
          );
        };
        
        // --- from App.tsx ---
        const cleanSentence = (str) => str.replace(/[â€™â€˜`]/g, "'").replace(/\s+/g, ' ').trim().toLowerCase();

        const shuffleArray = (array) => {
          const newArr = [...array];
          for (let i = newArr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
          }
          return newArr;
        };

        const getScrambledWords = (sentence) => {
          const words = sentence.split(/\s+/).filter(w => w.length > 0);
          return words.map((word, index) => ({ id: index, text: word }));
        };

        const InitialScreen = ({ onNameSubmit, initialName }) => {
            const [name, setName] = useState(initialName);
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (name.trim()) {
                    onNameSubmit(name.trim());
                } else {
                    setError("Vui lÃ²ng nháº­p tÃªn cá»§a báº¡n! (Please enter your name!)");
                }
            };

            return (
                React.createElement('form', { onSubmit: handleSubmit },
                    React.createElement('h1', { className: "text-3xl sm:text-4xl mb-2.5 text-[#3498db] font-semibold" }, "Nghe vÃ  Xáº¿p Tá»«"),
                    React.createElement('p', { className: "text-base sm:text-lg mb-4" }, "Luyá»‡n Tá»« Vá»±ng CÆ¡ Báº£n"),
                    React.createElement('p', { className: "text-sm sm:text-base" }, "Vui lÃ²ng nháº­p tÃªn cá»§a báº¡n Ä‘á»ƒ báº¯t Ä‘áº§u."),
                    React.createElement('input', {
                        type: "text",
                        value: name,
                        onChange: (e) => setName(e.target.value),
                        placeholder: "Your Name",
                        className: "w-full max-w-md p-3.5 text-base sm:text-lg my-5 mx-auto block box-border font-semibold bg-white text-slate-800 border-2 border-gray-200 rounded-xl transition-all duration-300 focus:outline-none focus:border-[#3498db] focus:shadow-lg focus:shadow-blue-200",
                        autoFocus: true
                    }),
                    React.createElement('p', { className: "text-red-500 font-semibold -mt-2 mb-2.5 text-sm min-h-[20px]" }, error),
                    React.createElement('button', {
                        type: "submit",
                        className: "py-3 px-6 text-base sm:text-lg cursor-pointer text-white border-none rounded-xl font-bold transition-all duration-300 bg-[#2ecc71] hover:enabled:bg-[#27ae60] hover:enabled:shadow-lg hover:enabled:shadow-green-300 hover:enabled:-translate-y-0.5"
                    }, "Start Game")
                )
            );
        };

        const UnitSelectionScreen = ({ units, playerName, onSelectUnit }) => {
            return (
                React.createElement('div', null,
                    React.createElement('h1', { className: "text-3xl sm:text-4xl mb-2.5 text-[#3498db] font-semibold" }, "Chá»n bÃ i há»c"),
                    React.createElement('p', { className: "text-base sm:text-lg mb-6" }, `Xin chÃ o ${playerName}, vui lÃ²ng chá»n má»™t chá»§ Ä‘á» Ä‘á»ƒ báº¯t Ä‘áº§u!`),
                    React.createElement('div', { className: "flex flex-col items-center gap-4" },
                        units.map((unit, index) => (
                            React.createElement('button', {
                                key: index,
                                onClick: () => onSelectUnit(index),
                                className: "w-full max-w-md py-4 px-6 text-lg cursor-pointer text-white border-none rounded-xl font-bold transition-all duration-300 bg-[#3498db] hover:enabled:bg-[#2980b9] hover:enabled:shadow-lg hover:enabled:shadow-blue-300 hover:enabled:-translate-y-0.5"
                            }, unit.question_vi)
                        ))
                    )
                )
            );
        };

        const WordTile = ({ word, type, onClick }) => {
            const baseClasses = "py-2 px-4 rounded-lg cursor-pointer text-base md:text-lg font-semibold shadow-md transition-all duration-150 select-none";
            const typeClasses = type === 'target'
                ? "bg-[#3498db] text-white border-2 border-[#2980b9]"
                : "bg-white border-2 border-gray-400 text-slate-800 hover:transform hover:-translate-y-0.5 hover:shadow-lg";

            return (
                React.createElement('div', { className: `${baseClasses} ${typeClasses}`, onClick: () => onClick(word, type) },
                    word.text
                )
            );
        };

        const GameScreen = (props) => {
            const { 
              currentItem, targetWords, sourceWords, onMoveWord, onPlaySound, 
              onCheck, onClear, onChangeUnit, onStartReadAloud, progress, score, 
              resultMessage, resultColor, isChecking, voices, selectedVoice, onVoiceChange
            } = props;
            return (
                React.createElement(React.Fragment, null,
                    React.createElement('h1', { className: "text-3xl sm:text-4xl mb-2.5 text-[#3498db] font-semibold" }, "Nghe vÃ  Xáº¿p Tá»«"),
                    React.createElement('p', { className: "text-sm sm:text-base mb-3" }, "Listen, then arrange the words to form the correct sentence."),
                    React.createElement('p', { className: "text-xl sm:text-2xl font-bold text-[#2980b9] my-5 p-2.5 bg-blue-100 rounded-xl min-h-[40px] whitespace-pre-wrap text-left sm:text-center" }, currentItem.vi_context),
                    React.createElement('div', { className: "min-h-[60px] p-2.5 rounded-xl my-4 flex flex-wrap items-center justify-center gap-2 transition-all bg-gray-100 border-2 border-dashed border-[#3498db]" },
                        targetWords.map(word => React.createElement(WordTile, { key: word.id, word: word, type: "target", onClick: onMoveWord }))
                    ),
                    React.createElement('div', { className: "min-h-[60px] p-4 rounded-xl my-4 flex flex-wrap items-center justify-center gap-2 transition-all bg-white/50 border border-gray-200" },
                        sourceWords.map(word => React.createElement(WordTile, { key: word.id, word: word, type: "source", onClick: onMoveWord }))
                    ),
                    React.createElement('div', { className: "my-4" },
                        React.createElement('label', { htmlFor: "voice-select", className: "block text-sm font-medium text-gray-700 mb-1" }, "Giá»ng Ä‘á»c (Voice):"),
                        React.createElement('select', {
                            id: "voice-select",
                            value: (selectedVoice === null || selectedVoice === void 0 ? void 0 : selectedVoice.name) || '',
                            onChange: onVoiceChange,
                            className: "w-full max-w-md p-2.5 text-base mx-auto block box-border bg-white text-slate-800 border-2 border-gray-200 rounded-xl transition-all duration-300 focus:outline-none focus:border-[#3498db] focus:shadow-lg focus:shadow-blue-200"
                        }, voices.map(voice => (
                            React.createElement('option', { key: voice.name, value: voice.name },
                                `${voice.name} (${voice.lang})`
                            )
                        )))
                    ),
                    React.createElement('div', { className: "flex flex-wrap justify-center gap-3 my-4" },
                        React.createElement('button', { onClick: onPlaySound, className: "py-3 px-6 text-base sm:text-lg cursor-pointer text-white border-none rounded-xl font-bold transition-all duration-300 bg-[#2ecc71] hover:enabled:bg-[#27ae60] hover:enabled:shadow-lg hover:enabled:shadow-green-300 hover:enabled:-translate-y-0.5 disabled:bg-gray-400 disabled:cursor-not-allowed" }, "â–¶ Nghe láº¡i"),
                        React.createElement('button', { onClick: onCheck, disabled: isChecking || targetWords.length === 0, className: "py-3 px-6 text-base sm:text-lg cursor-pointer text-white border-none rounded-xl font-bold transition-all duration-300 bg-[#3498db] hover:enabled:bg-[#2980b9] hover:enabled:shadow-lg hover:enabled:shadow-blue-300 hover:enabled:-translate-y-0.5 disabled:bg-gray-400 disabled:cursor-not-allowed" }, "Kiá»ƒm tra"),
                        React.createElement('button', { onClick: onClear, disabled: isChecking || targetWords.length === 0, className: "py-3 px-6 text-base sm:text-lg cursor-pointer text-slate-800 border-none rounded-xl font-bold transition-all duration-300 bg-[#f1c40f] hover:enabled:bg-[#f39c12] hover:enabled:shadow-lg hover:enabled:shadow-yellow-300 hover:enabled:-translate-y-0.5 disabled:bg-gray-400 disabled:cursor-not-allowed" }, "XÃ³a"),
                        React.createElement('button', { onClick: onStartReadAloud, className: "py-3 px-6 text-base sm:text-lg cursor-pointer text-white border-none rounded-xl font-bold transition-all duration-300 bg-[#1abc9c] hover:enabled:bg-[#16a085] hover:enabled:shadow-lg hover:enabled:shadow-teal-300 hover:enabled:-translate-y-0.5" }, "Äá»c láº¡i Unit"),
                        React.createElement('button', { onClick: onChangeUnit, className: "py-3 px-6 text-base sm:text-lg cursor-pointer text-white border-none rounded-xl font-bold transition-all duration-300 bg-gray-500 hover:enabled:bg-gray-600 hover:enabled:shadow-lg hover:enabled:shadow-gray-300 hover:enabled:-translate-y-0.5 disabled:bg-gray-400 disabled:cursor-not-allowed" }, "Chá»n Unit khÃ¡c")
                    ),
                    React.createElement('div', { className: "flex justify-around items-center bg-blue-100 rounded-xl p-2.5 mt-5" },
                        React.createElement('p', { className: "text-lg sm:text-xl font-bold text-[#2980b9]" }, `CÃ¢u: ${progress}`),
                        React.createElement('p', { className: "text-lg sm:text-xl font-bold text-[#2980b9]" }, `Äiá»ƒm: ${score}`)
                    ),
                    React.createElement('p', { className: `text-base sm:text-lg font-semibold mt-4 min-h-[28px] transition-colors ${resultColor}` },
                        resultMessage
                    )
                )
            );
        };

        const EndScreen = ({ playerName, score, total, mistakes, onChangeUnit, onReview, onStartReadAloud }) => {
          return (
            React.createElement('div', { className: "final-score text-center p-4" },
                React.createElement('h2', { className: "font-fredoka text-[#27ae60] text-5xl mb-1.5" }, "TrÃ² chÆ¡i káº¿t thÃºc!"),
                React.createElement('p', { className: "text-xl font-semibold mt-4" }, `ChÃºc má»«ng, ${playerName}!`),
                React.createElement('p', { className: "text-xl font-semibold mb-6" }, "Báº¡n Ä‘Ã£ hoÃ n thÃ nh:"),
                React.createElement('p', { className: "text-4xl font-bold text-slate-800" }, `${score} / ${total} cÃ¢u Ä‘Ãºng`),
                React.createElement('div', { className: "flex flex-wrap justify-center gap-3 mt-8" },
                    React.createElement('button', { onClick: onChangeUnit, className: "py-3 px-6 text-base sm:text-lg cursor-pointer text-white border-none rounded-xl font-bold transition-all duration-300 bg-[#3498db] hover:enabled:bg-[#2980b9] hover:enabled:shadow-lg hover:enabled:shadow-blue-300 hover:enabled:-translate-y-0.5" },
                        "Chá»n Unit khÃ¡c"
                    ),
                     React.createElement('button', { onClick: onStartReadAloud, className: "py-3 px-6 text-base sm:text-lg cursor-pointer text-white border-none rounded-xl font-bold transition-all duration-300 bg-[#1abc9c] hover:enabled:bg-[#16a085] hover:enabled:shadow-lg hover:enabled:shadow-teal-300 hover:enabled:-translate-y-0.5" },
                        "Äá»c láº¡i toÃ n bá»™ Unit"
                    ),
                    mistakes.length > 0 && (
                        React.createElement('button', { onClick: onReview, className: "py-3 px-6 text-base sm:text-lg cursor-pointer text-slate-800 border-none rounded-xl font-bold transition-all duration-300 bg-[#f1c40f] hover:enabled:bg-[#f39c12] hover:enabled:shadow-lg hover:enabled:shadow-yellow-300 hover:enabled:-translate-y-0.5" },
                            `Xem láº¡i lá»—i sai (${mistakes.length})`
                        )
                    )
                )
            )
          );
        };
        
        const App = () => {
          const [gameState, setGameState] = useState(GameState.Initial);
          const [playerName, setPlayerName] = useState('');
          const [playableItemsList, setPlayableItemsList] = useState([]);
          const [currentIndex, setCurrentIndex] = useState(0);
          const [score, setScore] = useState(0);
          const [mistakes, setMistakes] = useState([]);

          const [targetWords, setTargetWords] = useState([]);
          const [sourceWords, setSourceWords] = useState([]);
          const [wrongAttempts, setWrongAttempts] = useState(0);
          const [isChecking, setIsChecking] = useState(false);
          const [resultMessage, setResultMessage] = useState('Nghe vÃ  xáº¿p tá»«. (Listen and reorder.)');
          const [resultColor, setResultColor] = useState('text-slate-800');

          const [isReviewModalOpen, setReviewModalOpen] = useState(false);
          const [showConfetti, setShowConfetti] = useState(false);
          const [isReadingAloud, setIsReadingAloud] = useState(false);
          
          const [voices, setVoices] = useState([]);
          const [selectedVoice, setSelectedVoice] = useState(null);

          const isPlayingSpeech = useRef(false);
          const playTimeout = useRef(null);

          useEffect(() => {
            const loadVoices = () => {
                const availableVoices = window.speechSynthesis.getVoices().filter(v => v.lang.startsWith('en-'));
                setVoices(availableVoices);
                if (availableVoices.length > 0 && !selectedVoice) {
                    const femaleVoice = availableVoices.find(v => v.name.includes('Female') || v.name.includes('Google US English'));
                    setSelectedVoice(femaleVoice || availableVoices[0]);
                }
            };

            window.speechSynthesis.onvoiceschanged = loadVoices;
            loadVoices();
          }, [selectedVoice]);


          const stopSpeech = useCallback(() => {
            speechSynthesis.cancel();
            isPlayingSpeech.current = false;
            if (playTimeout.current) {
                clearTimeout(playTimeout.current);
            }
          }, []);

          const playSentence = useCallback((sentence, count = 0) => {
            if (isPlayingSpeech.current) return;
            if (!sentence) return;

            isPlayingSpeech.current = true;
            const utterance = new SpeechSynthesisUtterance(sentence);
            utterance.lang = 'en-US';
            utterance.rate = 0.9;
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }

            utterance.onend = () => {
              isPlayingSpeech.current = false;
              if (count < 1) {
                playTimeout.current = window.setTimeout(() => playSentence(sentence, count + 1), 1000);
              }
            };
            speechSynthesis.speak(utterance);
          }, [selectedVoice]);


          const setupNewTurn = useCallback(() => {
            if (currentIndex >= playableItemsList.length) return;
            const itemData = playableItemsList[currentIndex];
            setTargetWords([]);
            const scrambled = getScrambledWords(itemData.en);
            setSourceWords(shuffleArray(scrambled));
            setWrongAttempts(0);
            setIsChecking(false);
            setResultMessage('Nghe vÃ  xáº¿p tá»«. (Listen and reorder.)');
            setResultColor('text-slate-800');
            stopSpeech();
            playSentence(itemData.en);
          }, [currentIndex, playableItemsList, playSentence, stopSpeech]);


          const goToNextTurn = useCallback(() => {
            const nextIndex = currentIndex + 1;
            if (nextIndex >= playableItemsList.length) {
              stopSpeech();
              setGameState(GameState.Finished);
            } else {
              setCurrentIndex(nextIndex);
            }
          }, [currentIndex, playableItemsList.length, stopSpeech]);
          
          useEffect(() => {
            if (gameState === GameState.Playing) {
              setupNewTurn();
            }
          }, [gameState, setupNewTurn]);

          const handleNameSubmit = (name) => {
            setPlayerName(name);
            setGameState(GameState.UnitSelection);
          };
          
          const handleSelectUnit = (unitIndex) => {
            const selectedUnit = QA_PAIRS[unitIndex];
            const items = [];
            
            selectedUnit.answers.forEach(answer => {
                items.push({
                    en: answer.en,
                    vi_context: `${selectedUnit.question_vi}\nâžž ${answer.vi}`,
                    vi: answer.vi
                });
            });

            setPlayableItemsList(items);

            setCurrentIndex(0);
            setScore(0);
            setMistakes([]);
            setGameState(GameState.Playing);
          };

          const handleChangeUnit = () => {
            stopSpeech();
            setGameState(GameState.UnitSelection);
          };
          
          const handleCheckAnswer = () => {
            if (isChecking) return;
            setIsChecking(true);

            const userSentence = targetWords.map(w => w.text).join(' ');
            const currentItem = playableItemsList[currentIndex];

            if (cleanSentence(userSentence) === cleanSentence(currentItem.en)) {
              stopSpeech();
              setResultMessage("ChÃ­nh xÃ¡c! (Correct!) ðŸŽ‰");
              setResultColor('text-green-600');
              setShowConfetti(true);
              if (wrongAttempts < 3) {
                setScore(prev => prev + 1);
              }
              setTimeout(goToNextTurn, 2000);
            } else {
              const newWrongAttempts = wrongAttempts + 1;
              setWrongAttempts(newWrongAttempts);

              if (newWrongAttempts >= 3) {
                stopSpeech();
                const attempted = userSentence.length > 0 ? userSentence : 'Bá» qua (Skipped)';
                setMistakes(prev => [...prev, {
                  context_vi: currentItem.vi_context,
                  correct_en: currentItem.en,
                  attempted
                }]);
                setResultMessage("ÄÃ£ háº¿t lÆ°á»£t. Chuyá»ƒn sang cÃ¢u tiáº¿p theo...");
                setResultColor('text-slate-600');
                setTimeout(goToNextTurn, 2500);
              } else {
                setResultMessage(`KhÃ´ng Ä‘Ãºng, thá»­ láº¡i nhÃ©! (CÃ²n ${3 - newWrongAttempts} láº§n thá»­)`);
                setResultColor('text-red-500');
                setIsChecking(false);
              }
            }
          };

          const handleMoveWord = (word, from) => {
            if (from === 'source') {
              setSourceWords(prev => prev.filter(w => w.id !== word.id));
              setTargetWords(prev => [...prev, word]);
            } else {
              setTargetWords(prev => prev.filter(w => w.id !== word.id));
              setSourceWords(prev => [...prev, word]);
            }
            setResultMessage('Nghe vÃ  xáº¿p tá»«. (Listen and reorder.)');
            setResultColor('text-slate-800');
          };

          const handleClear = () => {
            setSourceWords(prev => [...prev, ...targetWords]);
            setTargetWords([]);
          };

          const handleVoiceChange = (event) => {
            const selectedVoiceName = event.target.value;
            const voice = voices.find(v => v.name === selectedVoiceName);
            if (voice) {
                setSelectedVoice(voice);
            }
          };

          const renderContent = () => {
            switch (gameState) {
              case GameState.Initial:
                return React.createElement(InitialScreen, { onNameSubmit: handleNameSubmit, initialName: playerName });
              case GameState.UnitSelection:
                return React.createElement(UnitSelectionScreen, { units: QA_PAIRS, playerName: playerName, onSelectUnit: handleSelectUnit });
              case GameState.Playing:
                if (!playableItemsList[currentIndex]) return null;
                return (
                  React.createElement(GameScreen, {
                    currentItem: playableItemsList[currentIndex],
                    targetWords: targetWords,
                    sourceWords: sourceWords,
                    onMoveWord: handleMoveWord,
                    onPlaySound: () => playSentence(playableItemsList[currentIndex].en, 1),
                    onCheck: handleCheckAnswer,
                    onClear: handleClear,
                    onChangeUnit: handleChangeUnit,
                    onStartReadAloud: () => setIsReadingAloud(true),
                    progress: `${currentIndex + 1} / ${playableItemsList.length}`,
                    score: score,
                    resultMessage: resultMessage,
                    resultColor: resultColor,
                    isChecking: isChecking,
                    voices: voices,
                    selectedVoice: selectedVoice,
                    onVoiceChange: handleVoiceChange
                  })
                );
              case GameState.Finished:
                return (
                  React.createElement(EndScreen, {
                    playerName: playerName,
                    score: score,
                    total: playableItemsList.length,
                    mistakes: mistakes,
                    onChangeUnit: handleChangeUnit,
                    onReview: () => setReviewModalOpen(true),
                    onStartReadAloud: () => setIsReadingAloud(true)
                  })
                );
              default:
                return null;
            }
          };

          return (
            React.createElement('div', { className: "flex flex-col items-center justify-center font-sans min-h-screen p-2.5 text-slate-800" },
                React.createElement(ConfettiContainer, { show: showConfetti, onAnimationEnd: () => setShowConfetti(false) }),
                React.createElement('div', { className: "text-center bg-white/95 backdrop-blur-sm p-6 sm:p-7 rounded-3xl shadow-2xl w-full max-w-3xl border-2 border-white relative z-10 my-5" },
                    renderContent()
                ),
                React.createElement(ReviewModal, {
                    isOpen: isReviewModalOpen,
                    onClose: () => setReviewModalOpen(false),
                    mistakes: mistakes
                }),
                isReadingAloud && (
                    React.createElement(ReadAloudScreen, { 
                        items: playableItemsList, 
                        onClose: () => {
                            speechSynthesis.cancel();
                            setIsReadingAloud(false);
                        },
                        selectedVoice: selectedVoice
                    })
                )
            )
          );
        };
        
        // --- from index.tsx ---
        const rootElement = document.getElementById('root');
        if (!rootElement) {
          throw new Error("Could not find root element to mount to");
        }

        const root = ReactDOM.createRoot(rootElement);
        root.render(
          React.createElement(React.StrictMode, null,
            React.createElement(App, null)
          )
        );
    </script>
</body>
</html>
